# GitLab CI/CD Configuration
# Construit l'image Docker avec le profil prod sur la branche develop

stages:
  - build
  - deploy

variables:
  # Version de Docker Compose
  DOCKER_COMPOSE_VERSION: "2.23.0"
  
  # Configuration du projet
  PROJECT_NAME: "cpascher"
  CONTAINER_NAME_PROD: "${PROJECT_NAME}-prod"
  CONTAINER_NAME_DEV: "${PROJECT_NAME}-dev"
  IMAGE_NAME: "${PROJECT_NAME}"
  REGISTRY_URL: "localhost:5100"
  
  # Ports
  DEV_PORT: "8888"
  PROD_PORT: "8888"

# ============================================================================
# STAGE: BUILD
# ============================================================================

# Build sur l'h√¥te avec profil dev
build:host-dev:
  stage: build
  script:
    - echo "üî® Construction de l'image Docker avec profil dev sur l'h√¥te..."
    - pwd
    - ls -la compose.yaml
    - docker compose --profile dev build --no-cache
    - echo "‚úÖ Image construite avec succ√®s"
    - docker images | grep ${PROJECT_NAME} || true
    - echo "üì§ Push vers le registre local..."
    - docker tag ${IMAGE_NAME}:dev ${REGISTRY_URL}/${IMAGE_NAME}:dev
    - docker push ${REGISTRY_URL}/${IMAGE_NAME}:dev
    - echo "‚úÖ Image pouss√©e vers ${REGISTRY_URL}/${IMAGE_NAME}:dev"
    - echo "=== Nettoyage du conteneur existant ==="
    - docker rm -f ${CONTAINER_NAME_DEV} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_DEV} 2>/dev/null || true
  only:
    - develop
  tags:
    - local
    - shell
  when: manual

# Build de l'image Docker avec profil prod quand develop est mise √† jour
build:docker-prod:
  stage: build
  script:
    - echo "üî® Construction de l'image Docker avec profil prod..."
    - pwd
    - ls -la
    - echo "=== Arr√™t des conteneurs existants ==="
    - docker compose --profile prod down || echo "Aucun conteneur √† arr√™ter"
    - docker rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - echo "=== Build de l'image ==="
    - docker compose --profile prod build --no-cache
    - echo "=== Push vers le registre local ==="
    - docker tag ${IMAGE_NAME}:prod ${REGISTRY_URL}/${IMAGE_NAME}:prod
    - docker push ${REGISTRY_URL}/${IMAGE_NAME}:prod
    - echo "‚úÖ Image pouss√©e vers ${REGISTRY_URL}/${IMAGE_NAME}:prod"
    - echo "=== Nettoyage du conteneur existant ==="
    - docker rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - sudo podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - docker ps -a --filter "name=${CONTAINER_NAME_PROD}" -q | xargs -r docker rm -f 2>/dev/null || true
    - podman ps -a --filter "name=${CONTAINER_NAME_PROD}" -q | xargs -r podman rm -f 2>/dev/null || true
    - sleep 2
    - echo "=== D√©marrage du conteneur ==="
    - docker compose --profile prod up -d
    - echo "=== V√©rification ==="
    - docker images | grep ${PROJECT_NAME} || true
    - docker ps -a | grep ${PROJECT_NAME} || true
    - echo "‚úÖ Image construite, pouss√©e et conteneur d√©marr√© avec succ√®s"
  only:
    - develop
  tags:
    - shell
    - local
  when: manual

# Build automatique apr√®s merge request valid√©e
build:on-merge:
  stage: build
  script:
    - echo "üîÄ Build apr√®s merge request valid√©e..."
    - echo "=== Arr√™t des conteneurs existants ==="
    - docker compose --profile prod down || echo "Aucun conteneur √† arr√™ter"
    - docker rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - echo "=== Build de l'image ==="
    - docker compose --profile prod build --no-cache
    - echo "=== Push vers le registre local ==="
    - docker tag ${IMAGE_NAME}:prod ${REGISTRY_URL}/${IMAGE_NAME}:prod
    - docker push ${REGISTRY_URL}/${IMAGE_NAME}:prod
    - echo "‚úÖ Image pouss√©e vers ${REGISTRY_URL}/${IMAGE_NAME}:prod"
    - echo "=== Nettoyage du conteneur existant ==="
    - docker rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - sudo podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - docker ps -a --filter "name=${CONTAINER_NAME_PROD}" -q | xargs -r docker rm -f 2>/dev/null || true
    - podman ps -a --filter "name=${CONTAINER_NAME_PROD}" -q | xargs -r podman rm -f 2>/dev/null || true
    - sleep 2
    - echo "=== D√©marrage du conteneur ==="
    - docker compose --profile prod up -d
    - echo "=== V√©rification ==="
    - docker images | grep ${PROJECT_NAME} || true
    - docker ps | grep ${PROJECT_NAME} || true
    - echo "‚úÖ Image construite, pouss√©e et conteneur d√©marr√© avec succ√®s"
  only:
    - merge_requests
  when: on_success
  tags:
    - shell
    - local

# Build pour les autres branches (optionnel - profil dev)
build:docker-dev:
  stage: build
  script:
    - echo "üî® Construction de l'image Docker avec profil dev..."
    - echo "=== Arr√™t des conteneurs existants ==="
    - docker compose --profile dev down || echo "Aucun conteneur √† arr√™ter"
    - docker rm -f ${CONTAINER_NAME_DEV} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_DEV} 2>/dev/null || true
    - echo "=== Build de l'image ==="
    - docker compose --profile dev build --no-cache
    - echo "=== Push vers le registre local ==="
    - docker tag ${IMAGE_NAME}:dev ${REGISTRY_URL}/${IMAGE_NAME}:dev
    - docker push ${REGISTRY_URL}/${IMAGE_NAME}:dev
    - echo "‚úÖ Image pouss√©e vers ${REGISTRY_URL}/${IMAGE_NAME}:dev"
    - echo "=== Nettoyage du conteneur existant ==="
    - docker rm -f ${CONTAINER_NAME_DEV} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_DEV} 2>/dev/null || true
    - sudo podman rm -f ${CONTAINER_NAME_DEV} 2>/dev/null || true
    - docker ps -a --filter "name=${CONTAINER_NAME_DEV}" -q | xargs -r docker rm -f 2>/dev/null || true
    - podman ps -a --filter "name=${CONTAINER_NAME_DEV}" -q | xargs -r podman rm -f 2>/dev/null || true
    - sleep 2
    - echo "=== D√©marrage du conteneur ==="
    - docker compose --profile dev up -d
    - echo "=== V√©rification ==="
    - docker images | grep ${PROJECT_NAME} || true
    - docker ps | grep ${PROJECT_NAME} || true
    - echo "‚úÖ Image construite, pouss√©e et conteneur d√©marr√© avec succ√®s"
  only:
    - /^feature\/.*/
    - /^bugfix\/.*/
  tags:
    - shell
    - local
  when: manual

# Build pour la production (main/master)
build:docker-production:

  stage: build
  script:
    - echo "üî® Construction de l'image Docker avec profil prod..."
    - echo "=== Arr√™t des conteneurs existants ==="
    - docker compose --profile prod down || echo "Aucun conteneur √† arr√™ter"
    - docker rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - echo "=== Build de l'image ==="
    - docker compose --profile prod build --no-cache
    - echo "=== Nettoyage du conteneur existant ==="
    - docker rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - sudo podman rm -f ${CONTAINER_NAME_PROD} 2>/dev/null || true
    - docker ps -a --filter "name=${CONTAINER_NAME_PROD}" -q | xargs -r docker rm -f 2>/dev/null || true
    - podman ps -a --filter "name=${CONTAINER_NAME_PROD}" -q | xargs -r podman rm -f 2>/dev/null || true
    - sleep 2
    - echo "üöÄ D√©marrage de l'image Docker de production..."
    - docker compose --profile prod up -d
    - echo "üì¶ Tagging de l'image..."
    - docker tag ${IMAGE_NAME}:prod ${IMAGE_NAME}:${CI_COMMIT_TAG:-latest}
    - docker images | grep ${PROJECT_NAME}
    - docker ps | grep ${PROJECT_NAME}
    - echo "üì§ Push vers le registre local..."
    - docker tag ${IMAGE_NAME}:prod ${REGISTRY_URL}/${IMAGE_NAME}:${CI_COMMIT_TAG:-latest}
    - docker push ${REGISTRY_URL}/${IMAGE_NAME}:${CI_COMMIT_TAG:-latest}
    - echo "‚úÖ Image pouss√©e vers ${REGISTRY_URL}/${IMAGE_NAME}:${CI_COMMIT_TAG:-latest}"
  only:
    - main
    - tags
  tags:
    - shell
    - local

# ============================================================================
# STAGE: DEPLOY (optionnel)
# ============================================================================

# D√©ploiement automatique sur develop
deploy:staging:

  stage: deploy
  script:
    - echo "üöÄ Red√©marrage en staging..."
    - docker compose --profile prod restart
    - echo "‚úÖ Application red√©marr√©e"
  environment:
    name: staging
    url: http://localhost:${PROD_PORT}
  only:
    - develop
  tags:
    - shell
    - local
  when: manual

# D√©ploiement en production
deploy:production:
  stage: deploy
  script:
    - echo "üöÄ D√©ploiement en production..."
    - echo "=== Red√©marrage du conteneur ==="
    - docker compose --profile prod restart
    - echo "=== Copie des fichiers depuis le conteneur (via tmp) ==="
    - mkdir -p ~/tmp/${PROJECT_NAME}-backup
    - docker cp ${CONTAINER_NAME_PROD}:/Sites/${PROJECT_NAME}/. ~/tmp/${PROJECT_NAME}-backup/
    - echo "=== D√©placement vers /var/www/html/${PROJECT_NAME} ==="
    - sudo rm -rf /var/www/html/${PROJECT_NAME}
    - sudo mkdir -p /var/www/html/${PROJECT_NAME}
    - sudo mv ~/tmp/${PROJECT_NAME}-backup/* /var/www/html/${PROJECT_NAME}/ 2>/dev/null || true
    - sudo mv ~/tmp/${PROJECT_NAME}-backup/.* /var/www/html/${PROJECT_NAME}/ 2>/dev/null || true
    - rm -rf ~/tmp/${PROJECT_NAME}-backup
    - echo "=== V√©rification des fichiers copi√©s ==="
    - ls -la /var/www/html/${PROJECT_NAME}/ | head -20
    - echo "‚úÖ Application d√©ploy√©e en production dans /var/www/html/${PROJECT_NAME}"
  environment:
    name: production
    url: $PRODUCTION_URL
  only:
    - main
    - tags
  tags:
    - shell
    - local
  when: manual


# Nettoyage des anciennes images (maintenance)
cleanup:images:

  stage: deploy
  script:
    - echo "üßπ Nettoyage des images non utilis√©es..."
    - docker image prune -f
    - docker system df
  only:
    - schedules
  tags:
    - shell
    - local
